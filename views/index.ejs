<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css" integrity="sha384-VCmXjywReHh4PwowAiWNagnWcLhlEJLA5buUprzK8rxFgeH0kww/aWY76TfkUoSX" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="/css/admin-css.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300&display=swap" rel="stylesheet"> 
    <link rel="icon" href="/images/bvi.png">
    
    <title>Admin</title>
  </head> 
  <body>

    <div class="d-flex">
      <ul class="navbar-nav sidebar sidebar-dark accordion">
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="admin">
          <div class="sidebar-brand-icon">
            <!-- <ion-icon name="american-football-outline" size="large"></ion-icon> -->
            <img src="/images/bvi.png" class="img-fluid mx-auto d-block admin-icon">
          </div>
          <div class="sidebar-brand-text mx-3">
            Admin
          </div>
        </a>

        <hr class="sidebar-divider my-0">

        <li class="nav-item active">
          <a class="nav-link" href="admin">
            <ion-icon name="people-circle-outline" style="font-size: 24px;"></ion-icon>
            <span>Users</span>
          </a>
        </li>

        <hr class="sidebar-divider my-0">

        <li class="nav-item">
          <a class="nav-link" href="payment_table">
            <ion-icon name="cash-outline" style="font-size: 24px;"></ion-icon>
            <span>Payments Pending</span>
          </a>
        </li>

        <hr class="sidebar-divider my-0">
        
        <li class="nav-item">
          <a class="nav-link" href="payments_completed">
            <ion-icon name="card-outline" style="font-size: 24px;"></ion-icon>
            <span>Payments Completed</span>
          </a>
        </li>

        <hr class="sidebar-divider my-0">

        <li class="nav-item">
          <a class="nav-link" href="v_change_no">
            <ion-icon name="shuffle-outline" style="font-size: 24px;"></ion-icon>
            <span>Change Vodacom Number</span>
          </a>
        </li>

        <hr class="sidebar-divider my-0">

        <li class="nav-item">
          <a class="nav-link" href="e_change_no">
            <ion-icon name="shuffle-outline" style="font-size: 24px;"></ion-icon>
            <span>Change Econet Number</span>
          </a>
        </li>

        <hr class="sidebar-divider my-0">

        <li class="nav-item">
          <a class="nav-link" href="mw_change_no">
            <ion-icon name="shuffle-outline" style="font-size: 24px;"></ion-icon>
            <span>Change myWallet Number</span>
          </a>
        </li>

        <hr class="sidebar-divider my-0">

        <li class="nav-item">
          <a class="nav-link" href="completed">
            <ion-icon name="checkmark-done-outline" style="font-size: 24px;"></ion-icon>
            <span>Times Completed</span>
          </a>
        </li>

        <hr class="sidebar-divider my-0"> 
      </ul>

      <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
          <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
            <button id="toggleSide" class="btn btn-link d-md-none mr-3">
              <!-- <ion-icon name="list-circle-outline" style="font-size: 30px;"></ion-icon> -->
              <ion-icon name="menu-outline" style="font-size: 30px; color: #344B9B"></ion-icon>
            </button>

            <ul class="navbar-nav ml-auto">
              <div class="topbar-divider d-none d-sm-block"></div>

              <li class="nav-item">
                <a class="nav-link">
                  <span class="mr-2 d-none d-lg-inline text-gray-600 small">Crowd Manager</span>
                  <img class="img-profile rounded-circle" src="https://source.unsplash.com/QAB-WJcbgJk/60x60">
                </a>
              </li>
            </ul>
          </nav>

          <div class="container-fluid">
            <div class="card shadow mb-4">
              <div class="card-header py-3">
                
                <ul class="nav nav-pills justify-content-center" id="myTab" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="one" data-toggle="tab" role="tab" aria-controls="one" aria-selected="true">Level 1</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="two" data-toggle="tab" role="tab" aria-controls="two" aria-selected="false">Level 2</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="three" data-toggle="tab" role="tab" aria-controls="three" aria-selected="false">Level 3</a>
                  </li>
                </ul>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table text-center" id="my_table">
                    <thead class="thead-dark">
                      <tr>
                        <th>#</th>
                        <th>Number</th>
                        <th>Name</th>
                        <th>Level</th>
                        <th>Num_paid</th>
                        <th>Num_received</th>
                        <th></th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    <% for(var i = 0; i < users.length; i++) {%>
                        <% for(var x = 0; x < users[i].length; x++) {%>
                      <tr>
                        <td><%= users[i][x].c_id %></td>
                        
                        <td><%= users[i][x].customer_phone_num %></td>
                        <td><%= users[i][x].customer_name %></td>
                        <td><%= users[i][x].level %></td>
                        <td><%= users[i][x].num_given %></td>
                        <td><%= users[i][x].num_received %></td>

                        <td>
                          <button type="button" class="btn myBtn" data-toggle="modal" data-target="#<%= users[i][x]._id.toString().substring(1, 7) %>">
                            Initialize Payment
                          </button>
                        </td>
                        <td>
                          <form method="GET" action="delete">
                            <input type="hidden" name="c_id" value="<%= users[i][x].c_id %>">
                            <input type="hidden" name="user_num" value="<%= users[i][x].customer_phone_num %>">
                            <button class="btn btn-outline-danger" style="padding: 4px">
                              <ion-icon name="trash-outline" style="font-size: 24px;"></ion-icon>
                            </button>
                          </form>
                        </td>
                      </tr>
            
                      <div class="modal fade" id="<%= users[i][x]._id.toString().substring(1, 7) %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="modal-body">
                              
                              <form action="activate" method="GET">
                                <input type="hidden" name="nibba" value="<%= users[i][x].customer_phone_num %>" >
                                <select class="form-control custom-select users" name="custom">
                                  
                                  <% for(var y = 0; y < users.length; y++) {%>
                                    <% for(var z = 0; z < users[y].length; z++) {%>
                                      <% var c_user = users[i][x] %>
                                      <% if (c_user.customer_phone_num != users[y][z].customer_phone_num) {%>
                                  <option><%= users[y][z].customer_phone_num + ", " + users[y][z].customer_name %></option>
                                      <% } %>
                                    <% } %> 
                                  <% } %> 
                                </select>
                                <!--  -->
                                <div id="userProfile">
                                  <div class="container">
                                    <div class="row">
                                      <div class="col-md-12">
                                        <h3 class="level"></h3>
                                      </div>
                                      <div class="col-md-6">
                                        <p class="given"></p>
                                      </div>
                                      <div class="col-md-6">
                                        <p class="give"></p> 
                                      </div>
                                    </div>
                                  </div>
                                </div>
            
                                <button type="submit" class="btn btn-primary">Submit</button>
                              </form>
                            </div>
                          </div>
                        </div>
                      </div>
                      <% } %>
                    <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    <!-- Optional JavaScript -->
    
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>

    <script src="https://unpkg.com/ionicons@5.1.2/dist/ionicons.js"></script>

    <script type="text/javascript">
      $(document).ready(function() {
        var firstL = document.getElementById("one");
        var secondL = document.getElementById("two");
        var thirdL = document.getElementById("three");
        var table_1 = $('#my_table').DataTable({
          "rowCallback": function(row, data, index){
            firstL.addEventListener("click", function() {
              if (data[3] == 1) {
                jQuery(row).show();
              } else {
                jQuery(row).hide();
              }
            });

            secondL.addEventListener("click", function() {
              if (data[3] == 2) {
                jQuery(row).show();
              } else {
                jQuery(row).hide();
              }
            });

            thirdL.addEventListener("click", function() {
              if (data[3] == 3) {
                jQuery(row).show();
              } else {
                jQuery(row).hide();
              }
            });
            
            if (data[3] > 1) {
              jQuery(row).hide();
            }
          }

        });

      });



      var element = document.querySelectorAll('.users');
      
      var data = <%- JSON.stringify(users) %>;

      element.forEach(item => {
        var id = item.parentElement.parentElement.parentElement.parentElement.id;
        var next = item.nextElementSibling;

        var displayInfo = function() {
          var findItem = item.options[item.selectedIndex].value.slice(0, 8);
          
          var numMoved = [];
          for (num = 0; num < data.length; num++) {
            for (x = 0; x < data[num].length; x++) {
              if (findItem == data[num][x].customer_phone_num) {
                numMoved.push(data[num][x].level, data[num][x].num_given, data[num][x].num_received)
              }
            }
          }

          next.querySelector('.level').innerHTML = "Level: " + numMoved[0];
          next.querySelector('.given').innerHTML = "Num Given: " + numMoved[1];
          next.querySelector('.give').innerHTML = "Num Received: " + numMoved[2];
        };

        displayInfo();

        item.addEventListener("change", displayInfo);

        $('#'+id).on('hidden.bs.modal', function () {
          $(this).find('form').trigger('reset');
          next.querySelector('.level').innerHTML = "";
          next.querySelector('.given').innerHTML = "";
          next.querySelector('.give').innerHTML = "";
        });  
      });

      $('#toggleSide').click(function() {
        $(".sidebar").animate({width:'toggle'},500);
      });
    </script>
  </body>
</html>